# Плагин для Obsidian

Плагин для Obsidian, предназначенный для управления сценариями Яндекс Умного Дома. Этот плагин позволяет импортировать, экспортировать, проверять, версионировать, сравнивать и симулировать сценарии Яндекс IoT, хранящиеся в формате YAML внутри файлов Markdown.

## Особенности

- **Импорт сценариев YAML**: Импорт сценариев Яндекс IoT из файлов `.yaml` или `.yml` в Obsidian в виде файлов Markdown.
- **Экспорт сценариев YAML**: Экспорт сценариев из файлов Markdown обратно в формат `.yaml`.
- **Контроль версий**: Создание версионных копий сценариев с временными метками для отслеживания изменений.
- **Проверка сценариев**: Проверка структуры и содержимого сценариев Яндекс IoT в формате YAML.
- **Генерация шаблонов сценариев**: Создание новых шаблонов сценариев для голосовых или расписанных триггеров.
- **Сравнение версий**: Сравнение текущего сценария с его версиями для выявления различий.
- **Симуляция сценариев**: Симуляция выполнения сценариев для просмотра их триггеров и шагов.
- **Просмотр версий**: Отображение списка всех версий сценария в отдельном файле Markdown.

## Установка и настройка

### Требования

- Obsidian версии 0.12.0 или выше.
- Установленный модуль `js-yaml` (встроен в плагин, дополнительная установка не требуется).

### Установка

1. Откройте Obsidian и перейдите в **Настройки** → **Сторонние плагины**.
2. Отключите **Безопасный режим**, если он включён.
3. Нажмите **Обзор** и найдите плагин **Yandex IoT Manager**.
4. Установите плагин и включите его в настройках.
5. Альтернативно, вы можете установить плагин вручную:
   - Скопируйте папку плагина (содержащую `main.js`, `manifest.json` и др.) в папку `<ваш_vault>/.obsidian/plugins/yandex-iot-manager/`.
   - Перезапустите Obsidian и включите плагин.

## Использование

После установки плагин добавляет несколько команд, доступных через **Панель команд** (Ctrl/Cmd + P). Вот основные команды и их описание:

### Команды

- **Импорт YAML-сценария** (`Import YAML Scenario`): Импортирует файл `.yaml` или `.yml` в ваш Vault как Markdown-файл с YAML-блоком.
- **Экспорт YAML-сценария** (`Export YAML Scenario`): Экспортирует YAML-содержимое активного Markdown-файла в `.yaml`-файл.
- **Создать версионную копию** (`Create Versioned Copy`): Создаёт копию текущего сценария с временной меткой в папке `versions`.
- **Показать версии сценария** (`Show Scenario Versions`): Создаёт или обновляет Markdown-файл со списком всех версий текущего сценария.
- **Проверить YAML-сценарий** (`Validate YAML Scenario`): Проверяет правильность структуры и содержимого YAML-сценария.
- **Создать шаблон сценария** (`Generate Scenario Template`): Создаёт новый шаблон сценария с голосовым или расписанным триггером.
- **Сравнить версии сценария** (`Compare Scenario Versions`): Позволяет выбрать версию для сравнения с текущим сценарием и создаёт файл с различиями.
- **Симулировать сценарий** (`Simulate Scenario`): Выводит уведомление с симуляцией триггеров и шагов текущего сценария.

### Пример использования

1. Откройте **Панель команд** (Ctrl/Cmd + P).
2. Выберите **Generate Scenario Template**, чтобы создать новый сценарий.
3. Выберите тип триггера (например, "Voice" или "Timetable") в открывшемся окне.
4. Новый Markdown-файл с шаблоном сценария будет создан в вашем Vault.
5. Отредактируйте YAML-блок в файле, затем используйте **Validate YAML Scenario** для проверки.
6. Создайте версионную копию с помощью **Create Versioned Copy**.
7. Сравните версии или симулируйте сценарий по мере необходимости.

## Структура YAML-сценария

Плагин работает с YAML-файлами, содержащими сценарии Яндекс Умного Дома. Пример структуры:

```yaml
scenarios:
  - id: scenario_123456789
    name: Утренний свет
    triggers:
      - trigger:
          type: scenario.trigger.voice
          value: Включи утренний свет
    steps:
      - type: scenarios.steps.actions.v2
        parameters:
          items:
            - id: light_001
              type: devices.types.light
```

### Поля сценария

- `id`: Уникальный идентификатор сценария (строка).
- `name`: Название сценария (строка).
- `triggers`: Массив триггеров (голосовые, по расписанию и т.д.).
- `steps`: Массив действий, выполняемых при срабатывании триггера.

## Примечания

- Плагин автоматически создаёт папку `versions` в корне вашего Vault для хранения версионных копий.
- Для сравнения версий используется простая текстовая разница, основанная на JSON-представлении данных.
- Симуляция сценариев выводит уведомление с текстовым описанием триггеров и шагов, не взаимодействуя с реальными устройствами.
- Убедитесь, что YAML-содержимое находится внутри блока ```yaml в Markdown-файле.

## Техническая информация

### Используемые технологии

- **Obsidian API**: Для интеграции с Obsidian и управления файлами.
- **js-yaml**: Для парсинга и валидации YAML-содержимого.
- **TypeScript**: Код плагина написан на TypeScript для типобезопасности.

### Структура проекта

- `main.ts`: Основной файл плагина, содержащий логику команд.
- `manifest.json`: Манифест плагина для Obsidian.
- `types.ts`: Определения типов для сценариев Яндекс IoT.

## Разработка и отладка

Для разработки плагина:

1. Склонируйте репозиторий или создайте копию исходного кода.
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Соберите плагин:
   ```bash
   npm run build
   ```
4. Скопируйте скомпилированные файлы в папку плагинов вашего Vault.

Для отладки используйте консоль разработчика Obsidian (Ctrl/Cmd + Shift + I).

# To do
- Расширение /Validate YAML Scenario
- Улучшить ui /Compare Scenario Versions
- Улучшить ui /Simulate Scenario, отчет в файлик кидать
- Интеграция с яндекс диском
- Интеграция с git/github
- Интеграция с модулем yaml-scenario-extension
- Управление сценариями из obsidian
